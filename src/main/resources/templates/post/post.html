<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button onclick="goMain()">홈으로</button>
    <h1><span th:text="${dto.reqPostDTO.title}">제목</span></h1>
    <div>글쓴이: <span th:text="${dto.reqPostDTO.userId}">test</span></div>

    <div>
      <span th:text="${dto.reqPostDTO.content}">내용</span>
    </div>
    <div>
      글 쓴 시간 : <span th:text="${dto.reqPostDTO.createDate}">오늘</span>
    </div>
    <div>
      업데이트 시간 <span th:text="${dto.reqPostDTO.updateDate}"></span>
    </div>

    <div
      th:if="${session != null and session.dto != null and dto.reqPostDTO.userIdx == session.dto.user.idx}"
    >
      <button th:onclick="goUpdate([[${dto.reqPostDTO.idx}]])">
        게시글 수정
      </button>
    </div>
    <div
      th:if="${session != null and session.dto != null and dto.reqPostDTO.userIdx == session.dto.user.idx}"
    >
      <button th:onclick="postDelete([[${dto.reqPostDTO.idx}]])">
        게시글 삭제
      </button>
    </div>

    <div
      th:if="${session != null and session.dto != null and session.dto.user != null and session.dto.user.roleList != null and session.dto.user.roleList.contains('ADMIN')}"
    >
      <button th:onclick="adminPostDelete([[${dto.reqPostDTO.idx}]])">
        관리자 삭제
      </button>
    </div>

    <h2>덧글</h2>

    <div>
      <textarea
        th:if="${session.dto != null}"
        id="comment"
        name="comment"
      ></textarea>
      <button
        th:if="${session.dto != null}"
        th:onclick="commentWrite([[${dto.reqPostDTO.idx}]])"
      >
        덧글 쓰기
      </button>
    </div>

    <div>
      <table border="0">
        <th>아이디</th>
        <th>내용</th>
        <th>글 쓴 시간</th>
        <th>업데이트 시간</th>
        <tr th:each="commentDTO : ${dto.reqPostDTO.resCommentDTOList}">
          <td th:text="${commentDTO.userId}">글쓴이</td>
          <td th:text="${commentDTO.content}">내용</td>
          <td th:text="${commentDTO.createDate}">글 쓴 시간</td>
          <td th:text="${commentDTO.updateDate}">업데이트 시간</td>
          <td
            th:if="${session != null and session.dto != null and session.dto.user != null and session.dto.user.roleList != null and session.dto.user.roleList.contains('ADMIN')}"
          >
            <button th:onclick="adminCommentDelete([[${commentDTO.idx}]])">
              관리자 삭제
            </button>
          </td>
          <td
            th:if="${session != null and session.dto != null and commentDTO.userIdx == session.dto.user.idx}"
          >
            <button th:onclick="updateComment([[${commentDTO.idx}]])">
              수정
            </button>
          </td>
          <td
            th:if="${session != null and session.dto != null and commentDTO.userIdx == session.dto.user.idx}"
          >
            <button th:onclick="deleteComment([[${commentDTO.idx}]])">
              삭제
            </button>
          </td>
        </tr>
      </table>
    </div>

    <script th:inline="javascript">
      const updateComment = (idx) => {
        window.location.href = "/post/comment/" + idx;
      };

      const deleteComment = (idx) => {
        const dto = {
          comment: {
            idx: idx,
          },
        };

        fetch("/api/v1/post/comment/delete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=utf-8",
          },
          body: JSON.stringify(dto),
        })
          .then((response) => response.json())
          .then((result) => {
            alert(result.message);

            if (result.code === 0) {
              location.reload();
            }
          });
      };

      const checkInput = () => {
        comment = document.getElementById("comment");

        if (sessionStorage === null) {
          alert("로그인을 해주세요");
          return false;
        }

        if (comment.value.trim() === "" || comment.value.trim() === null) {
          alert("댓글을 입력해주세요");
          return false;
        }
        return true;
      };

      const commentWrite = (idx) => {
        if (!checkInput()) {
          return;
        }

        const dto = {
          comment: {
            content: document.getElementById("comment").value,
            postIdx: idx,
          },
        };

        fetch("/api/v1/post/comment/write", {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=utf-8",
          },
          body: JSON.stringify(dto),
        })
          .then((response) => response.json())
          .then((result) => {
            alert(result.message);

            if (result.code === 0) {
              location.reload();
            }
          });
      };

      const adminCommentDelete = (idx) => {
        const dto = {
          comment: {
            idx: idx,
          },
        };

        fetch("/api/v1/post/admin/comment/delete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=utf-8",
          },
          body: JSON.stringify(dto),
        })
          .then((response) => response.json())
          .then((result) => {
            alert(result.message);

            if (result.code === 0) {
              location.reload();
            }
          });
      };

      const adminPostDelete = (idx) => {
        const dto = {
          post: {
            idx: idx,
          },
        };

        fetch("/api/v1/post/admin/delete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=utf-8",
          },
          body: JSON.stringify(dto),
        })
          .then((response) => response.json())
          .then((result) => {
            alert(result.message);

            if (result.code === 0) {
              location.replace("/");
            }
          });
      };

      const postDelete = (idx) => {
        const dto = {
          post: {
            idx: idx,
          },
        };

        fetch("/api/v1/post/delete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=utf-8",
          },
          body: JSON.stringify(dto),
        })
          .then((response) => response.json())
          .then((result) => {
            alert(result.message);

            if (result.code === 0) {
              location.replace("/");
            }
          });
      };

      const goUpdate = (idx) => {
        window.location.href = "/post/update/" + idx;
      };

      const goMain = () => {
        window.location.href = "/";
      };
    </script>
  </body>
</html>
